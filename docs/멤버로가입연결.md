# MEMBER íšŒì›ê°€ì… ë° User-Member ì—°ê²° í™•ì¥ ê³„íš

## ğŸ“‹ í˜„ì¬ êµ¬ì¡°

### í˜„ì¬ ìƒíƒœ (ê°œë°œ ë‹¨ê³„)

1. **User ì—”í‹°í‹°** (ë¡œê·¸ì¸/ì¸ì¦)
   - `role`: MEMBER, TRAINER, ADMIN
   - MEMBERë¡œ íšŒì›ê°€ì… ê°€ëŠ¥ (`isApproved: true`)
   - Member ì—”í‹°í‹°ì™€ **ì—°ê²° ì—†ìŒ** (ë…ë¦½ì )

2. **Member ì—”í‹°í‹°** (í—¬ìŠ¤ì¥ íšŒì› ë°ì´í„°)
   - TRAINER/ADMINì´ ì§ì ‘ ë“±ë¡
   - Userì™€ **ë…ë¦½ì ** (ì—°ê²° ê´€ê³„ ì—†ìŒ)
   - `userId` í•„ë“œ ì—†ìŒ
   - `trainerId` í•„ë“œ ì—†ìŒ

3. **ê¶Œí•œ ì²´í¬**
   - Member ì¡°íšŒ: ì¸ì¦ë§Œ í•„ìš” (ë³¸ì¸ ë°ì´í„° í™•ì¸ ì—†ìŒ)
   - Member ìƒì„±/ìˆ˜ì •: ADMIN, TRAINERë§Œ ê°€ëŠ¥
   - MEMBER ì—­í•  UserëŠ” ë³¸ì¸ Member ë°ì´í„° ì ‘ê·¼ ë¶ˆê°€

---

## ğŸ¯ ì¶”í›„ í™•ì¥ ê³„íš (ë°°í¬ í›„)

### ìš”êµ¬ì‚¬í•­

1. **MEMBER ì—­í•  Userê°€ íšŒì›ê°€ì…**
   - ìë™ìœ¼ë¡œ Member ìƒì„± ë˜ëŠ” ì—°ê²°
   - ê°œì¸ ìš´ë™ ê¸°ë¡ ë° ë£¨í‹´ ì„¤ì • ê°€ëŠ¥

2. **TRAINERê°€ Memberë¥¼ ì´ˆëŒ€í•´ì„œ ê´€ë¦¬**
   - TRAINERê°€ Memberë¥¼ ìì‹ ì˜ íšŒì›ìœ¼ë¡œ ì´ˆëŒ€
   - TRAINERëŠ” ìì‹ ì´ ê´€ë¦¬í•˜ëŠ” Memberë§Œ ì¡°íšŒ/ìˆ˜ì • ê°€ëŠ¥

3. **Memberê°€ ê°œì¸ ìš´ë™ ê¸°ë¡ ë° ë£¨í‹´ ì„¤ì •**
   - ë³¸ì¸ì˜ ìš´ë™ ê¸°ë¡ ì¡°íšŒ/ë“±ë¡
   - ë³¸ì¸ì˜ ìš´ë™ ë£¨í‹´ ì„¤ì •

---

## ğŸ”§ í•„ìš”í•œ ë³€ê²½ì‚¬í•­ (ì¶”í›„ ì¶”ê°€ ë°©ì‹)

### 1. Member ì—”í‹°í‹° í™•ì¥

**íŒŒì¼**: `src/entities/member.entity.ts`

```typescript
@Entity('members')
export class Member {
  // ê¸°ì¡´ í•„ë“œë“¤...
  
  // ì¶”ê°€ í•„ë“œ (nullable: ê¸°ì¡´ ë°ì´í„° í˜¸í™˜)
  @Column({ name: 'user_id', nullable: true })
  userId?: string; // Userì™€ ì—°ê²° (nullable: ê¸°ì¡´ ë°ì´í„° í˜¸í™˜)
  
  @Column({ name: 'trainer_id', nullable: true })
  trainerId?: string; // ê´€ë¦¬í•˜ëŠ” TRAINER (nullable)
  
  @ManyToOne(() => User, { nullable: true })
  @JoinColumn({ name: 'user_id' })
  user?: User; // Userì™€ ê´€ê³„ (ì„ íƒì )
  
  @ManyToOne(() => User, { nullable: true })
  @JoinColumn({ name: 'trainer_id' })
  trainer?: User; // TRAINERì™€ ê´€ê³„ (ì„ íƒì )
}
```

**SQL ë§ˆì´ê·¸ë ˆì´ì…˜**: `database/add_user_trainer_to_members.sql`

```sql
-- members í…Œì´ë¸”ì— user_id, trainer_id ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE members
ADD COLUMN IF NOT EXISTS user_id UUID NULL,
ADD COLUMN IF NOT EXISTS trainer_id UUID NULL;

-- ì™¸ë˜í‚¤ ì„¤ì •
ALTER TABLE members
ADD CONSTRAINT fk_members_user_id 
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL;

ALTER TABLE members
ADD CONSTRAINT fk_members_trainer_id 
FOREIGN KEY (trainer_id) REFERENCES users(id) ON DELETE SET NULL;

-- ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX IF NOT EXISTS idx_members_user_id ON members(user_id);
CREATE INDEX IF NOT EXISTS idx_members_trainer_id ON members(trainer_id);
```

---

### 2. íšŒì›ê°€ì… ì‹œ Member ìë™ ìƒì„± (ì„ íƒì )

**íŒŒì¼**: `src/modules/auth/auth.service.ts`

```typescript
async register(registerDto: RegisterDto) {
  // User ìƒì„±
  const user = await this.userRepository.save({...});
  
  // MEMBER ì—­í• ì´ë©´ Member ìë™ ìƒì„± (ì„ íƒì )
  if (user.role === Role.MEMBER) {
    await this.memberRepository.create({
      userId: user.id,
      email: user.email,
      name: user.name,
      phone: registerDto.phone, // íšŒì›ê°€ì… ì‹œ ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ìš”
      joinDate: new Date(),
      status: MemberStatus.ACTIVE,
    });
  }
  
  return user;
}
```

**RegisterDto í™•ì¥**:

```typescript
export class RegisterDto {
  // ê¸°ì¡´ í•„ë“œ...
  phone?: string; // MEMBER ì—­í• ì¼ ë•Œ í•„ìˆ˜
}
```

---

### 3. ê¶Œí•œ ì²´í¬ ë¡œì§ ì¶”ê°€

**íŒŒì¼**: `src/modules/members/members.service.ts`

```typescript
async findOne(id: string, currentUser?: User): Promise<Member> {
  const member = await this.memberRepository.findOne({ where: { id } });
  
  if (!member) {
    throw ApiExceptions.memberNotFound();
  }
  
  // ê¶Œí•œ ì²´í¬
  if (currentUser?.role === Role.MEMBER) {
    // ë³¸ì¸ ë°ì´í„°ë§Œ ì ‘ê·¼ ê°€ëŠ¥
    if (member.userId !== currentUser.id) {
      throw ApiExceptions.forbidden('ë³¸ì¸ì˜ ë°ì´í„°ë§Œ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    }
  } else if (currentUser?.role === Role.TRAINER) {
    // TRAINERëŠ” ìì‹ ì´ ê´€ë¦¬í•˜ëŠ” Memberë§Œ ì ‘ê·¼ ê°€ëŠ¥
    if (member.trainerId !== currentUser.id) {
      throw ApiExceptions.forbidden('ê´€ë¦¬í•˜ëŠ” íšŒì›ì˜ ë°ì´í„°ë§Œ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    }
  }
  
  return member;
}
```

---

### 4. TRAINER ì´ˆëŒ€ ê¸°ëŠ¥ (ìƒˆë¡œìš´ API)

**íŒŒì¼**: `src/modules/members/members.controller.ts`

```typescript
@Post('invite')
@UseGuards(RolesGuard)
@Roles(Role.TRAINER, Role.ADMIN)
@ApiOperation({ summary: 'íšŒì› ì´ˆëŒ€', description: 'TRAINERê°€ Memberë¥¼ ìì‹ ì˜ íšŒì›ìœ¼ë¡œ ì´ˆëŒ€í•©ë‹ˆë‹¤.' })
async inviteMember(
  @Body() inviteDto: InviteMemberDto,
  @CurrentUser() currentUser: User,
) {
  const member = await this.membersService.inviteMember(
    inviteDto.email,
    currentUser.id,
  );
  return ApiResponseHelper.success(member, 'íšŒì› ì´ˆëŒ€ ì„±ê³µ');
}
```

**DTO**: `src/modules/members/dto/invite-member.dto.ts`

```typescript
export class InviteMemberDto {
  @IsEmail()
  email: string; // ì´ˆëŒ€í•  íšŒì›ì˜ ì´ë©”ì¼
}
```

**Service ë¡œì§**: `src/modules/members/members.service.ts`

```typescript
async inviteMember(email: string, trainerId: string): Promise<Member> {
  // User ì¡°íšŒ
  const user = await this.userRepository.findOne({ where: { email } });
  
  if (!user || user.role !== Role.MEMBER) {
    throw ApiExceptions.userNotFound('MEMBER ì—­í• ì˜ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  // Member ì¡°íšŒ ë˜ëŠ” ìƒì„±
  let member = await this.memberRepository.findOne({ where: { userId: user.id } });
  
  if (!member) {
    // Memberê°€ ì—†ìœ¼ë©´ ìƒì„±
    member = this.memberRepository.create({
      userId: user.id,
      email: user.email,
      name: user.name,
      phone: '', // ë‚˜ì¤‘ì— ìˆ˜ì • ê°€ëŠ¥
      joinDate: new Date(),
      status: MemberStatus.ACTIVE,
      trainerId,
    });
  } else {
    // Memberê°€ ìˆìœ¼ë©´ trainerIdë§Œ ì—…ë°ì´íŠ¸
    member.trainerId = trainerId;
  }
  
  return this.memberRepository.save(member);
}
```

---

### 5. ë³¸ì¸ ë°ì´í„° ì ‘ê·¼ API ì¶”ê°€

**íŒŒì¼**: `src/modules/members/members.controller.ts`

```typescript
@Get('me')
@ApiOperation({ summary: 'ë³¸ì¸ íšŒì› ì •ë³´ ì¡°íšŒ', description: 'MEMBER ì—­í•  ì‚¬ìš©ìê°€ ë³¸ì¸ì˜ íšŒì› ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.' })
async getMyMember(@CurrentUser() currentUser: User) {
  const member = await this.membersService.findByUserId(currentUser.id);
  return ApiResponseHelper.success(member, 'ë³¸ì¸ íšŒì› ì •ë³´ ì¡°íšŒ ì„±ê³µ');
}
```

**Service ë©”ì„œë“œ**:

```typescript
async findByUserId(userId: string): Promise<Member> {
  const member = await this.memberRepository.findOne({
    where: { userId },
  });
  
  if (!member) {
    throw ApiExceptions.memberNotFound('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  
  return member;
}
```

---

## ğŸ“Š êµ¬í˜„ ì „ëµ

### Phase 1: í˜„ì¬ (ê°œë°œ ë‹¨ê³„)
- âœ… TRAINER/ADMINì´ Member ì§ì ‘ ë“±ë¡
- âœ… Userì™€ Member ë…ë¦½ì 
- âœ… ê¸°ì¡´ êµ¬ì¡° ìœ ì§€

### Phase 2: ì¶”í›„ í™•ì¥ (ë°°í¬ í›„)
- [ ] Member ì—”í‹°í‹°ì— `userId`, `trainerId` í•„ë“œ ì¶”ê°€
- [ ] SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] íšŒì›ê°€ì… ì‹œ Member ìë™ ìƒì„± ë¡œì§ ì¶”ê°€ (ì„ íƒì )
- [ ] ê¶Œí•œ ì²´í¬ ë¡œì§ ì¶”ê°€
- [ ] TRAINER ì´ˆëŒ€ API ì¶”ê°€
- [ ] ë³¸ì¸ ë°ì´í„° ì ‘ê·¼ API ì¶”ê°€

---

## ğŸ” ë³€ê²½ ë²”ìœ„ í‰ê°€

### ìµœì†Œ ë³€ê²½ (ì¶”ì²œ)
- âœ… Member ì—”í‹°í‹°ì— í•„ë“œ 2ê°œ ì¶”ê°€ (`userId`, `trainerId`)
- âœ… SQL ë§ˆì´ê·¸ë ˆì´ì…˜: ì»¬ëŸ¼ ì¶”ê°€ë§Œ
- âœ… ê¸°ì¡´ API í˜¸í™˜ì„± ìœ ì§€
- âœ… ìƒˆë¡œìš´ ê¶Œí•œ ì²´í¬ ë¡œì§ ì¶”ê°€

### ë³€ê²½ ì˜í–¥ë„
- âœ… ê¸°ì¡´ ë°ì´í„°: ì˜í–¥ ì—†ìŒ (nullable í•„ë“œ)
- âœ… ê¸°ì¡´ API: í˜¸í™˜ì„± ìœ ì§€ ê°€ëŠ¥
- âœ… ìƒˆë¡œìš´ ê¸°ëŠ¥: ì¶”ê°€ë§Œ í•˜ë©´ ë¨

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **íšŒì›ê°€ì… ì‹œ ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ìš”**
   - MEMBER ì—­í• ë¡œ íšŒì›ê°€ì… ì‹œ Member ìƒì„±ìš©
   - RegisterDtoì— `phone` í•„ë“œ ì¶”ê°€ í•„ìš”

2. **ë³¸ì¸ ë°ì´í„° ì ‘ê·¼ ì²´í¬ ë¡œì§ í•„ìˆ˜**
   - MEMBERëŠ” ë³¸ì¸ ë°ì´í„°ë§Œ ì ‘ê·¼ ê°€ëŠ¥
   - TRAINERëŠ” ê´€ë¦¬í•˜ëŠ” Memberë§Œ ì ‘ê·¼ ê°€ëŠ¥

3. **TRAINER ì´ˆëŒ€ ì‹œ ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬**
   - ì´ë¯¸ ë‹¤ë¥¸ TRAINERê°€ ê´€ë¦¬í•˜ëŠ” Memberì¸ì§€ í™•ì¸
   - ì¤‘ë³µ ì´ˆëŒ€ ë°©ì§€ ë¡œì§ í•„ìš”

4. **ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜**
   - ê¸°ì¡´ Member ë°ì´í„°ëŠ” `userId`, `trainerId`ê°€ NULL
   - ê¸°ì¡´ ë°©ì‹(TRAINER ì§ì ‘ ë“±ë¡)ê³¼ ìƒˆ ë°©ì‹(MEMBER íšŒì›ê°€ì…) ë³‘í–‰ ê°€ëŠ¥

---

## ğŸ“ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì¶”í›„)

### DB ì‘ì—…
- [ ] `database/add_user_trainer_to_members.sql` ìƒì„±
- [ ] SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] ì¸ë±ìŠ¤ ìƒì„± í™•ì¸

### ì—”í‹°í‹° ìˆ˜ì •
- [ ] `src/entities/member.entity.ts`ì— í•„ë“œ ì¶”ê°€
- [ ] User ì—”í‹°í‹°ì™€ ê´€ê³„ ì„¤ì •

### DTO ìˆ˜ì •
- [ ] `RegisterDto`ì— `phone` í•„ë“œ ì¶”ê°€
- [ ] `InviteMemberDto` ìƒì„±

### Service ìˆ˜ì •
- [ ] `AuthService.register()` ìˆ˜ì • (Member ìë™ ìƒì„±)
- [ ] `MembersService.findOne()` ê¶Œí•œ ì²´í¬ ë¡œì§ ì¶”ê°€
- [ ] `MembersService.findByUserId()` ë©”ì„œë“œ ì¶”ê°€
- [ ] `MembersService.inviteMember()` ë©”ì„œë“œ ì¶”ê°€

### Controller ìˆ˜ì •
- [ ] `MembersController.getMyMember()` ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
- [ ] `MembersController.inviteMember()` ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
- [ ] ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ì— ê¶Œí•œ ì²´í¬ ë¡œì§ ì¶”ê°€

### í…ŒìŠ¤íŠ¸
- [ ] íšŒì›ê°€ì… ì‹œ Member ìë™ ìƒì„± í…ŒìŠ¤íŠ¸
- [ ] ë³¸ì¸ ë°ì´í„° ì ‘ê·¼ ê¶Œí•œ í…ŒìŠ¤íŠ¸
- [ ] TRAINER ì´ˆëŒ€ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
- [ ] ê¸°ì¡´ API í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸

---

**ì‘ì„±ì¼**: 2026-01-06
**ìƒíƒœ**: ì¶”í›„ í™•ì¥ ê³„íš ìˆ˜ë¦½ ì™„ë£Œ, êµ¬í˜„ ëŒ€ê¸° ì¤‘

